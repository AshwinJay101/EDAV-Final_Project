---
title: "Health of US Healthcare"
author: "Akshat Mittal; Asaf Gal; Ashwin Jayaraman; Rapahel Kintzer"
date: "December 9, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(mi)
library(extracat)
library(choroplethr)
library(choroplethrMaps)
```

```{r message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}
data_2011 <- read_csv('Data/Medicare_Provider_Charge_Inpatient_DRG100_FY2011.csv')
data_2012 <- read_csv('Data/Medicare_Provider_Charge_Inpatient_DRG100_FY2012.csv')
data_2013 <- read_csv('Data/Medicare_Provider_Charge_Inpatient_DRG100_FY2013.csv')
data_2014 <- read_csv("Data/Medicare_Provider_Charge_Inpatient_DRGALL_FY2014.csv")
data_2015 <- read_csv("Data/Medicare_Provider_Charge_Inpatient_DRGALL_FY2015.csv")
data_2016 <- read_csv("Data/Medicare_Provider_Charge_Inpatient_DRGALL_FY2016.csv")

data_2011$Year <- 2011
data_2012$Year <- 2012
data_2013$Year <- 2013
data_2014$Year <- 2014
data_2015$Year <- 2015
data_2016$Year <- 2016

data <- rbind(data_2011,data_2012,data_2013,data_2014,data_2015,data_2016)

rm(data_2011, data_2012, data_2013, data_2014, data_2015, data_2016)
```


# Introduction

## Questions/Motivation for choosing the topic

<font size="4">
According to [Commonwealth Fund](https://www.commonwealthfund.org/publications/issue-briefs/2015/oct/us-health-care-global-perspective) , spendings for the Healthcare Industry in the US as a percentage of the GDP is 32% higher than France. The gap can be illustrated in the following graph. 
</font>
<!-- ![](PercentGDP.png) -->
```{r fig.width=8, fig.height=8,echo=FALSE}
library(png)
library(grid)
img <- readPNG("PercentGDP.png")
 grid.raster(img)
```

<font size="4">
Medicare also contributes a lot to this cost. According to this [Forbes article](https://www.forbes.com/sites/danmunro/2012/12/30/2012-the-year-in-healthcare-charts/#1d34e95f6c8c), Annual per capita cost increases exponentially in the US as the age increases. 

```{r fig.width=8, fig.height=8,echo=FALSE}
library(png)
library(grid)
img <- readPNG("CostByAge.jpg")
 grid.raster(img)
```



The graphs above motivated us to try and understand what is driving the major costs. Are there some disease categories which are contributing a lot to those costs? We wanted to understand the efficiency of the healthcare industry. Looking at the 2nd graph motivated us to search for the Medicare dataset and understand what are some  good efficiency metrics. 


We were also interested in the mortality rate over time. This would allow us to see whether improvements in healthcare technology have decreased the overall mortality rate. The buckets of age for which mortality rate decreased over time as the years increased also intrigued us.


Another motivation for using the mortality data set is that we wanted to understand whether the medicare spending makes sense according to the Disease Categories. For example, is there a correlation between the amount spent on a disease category( or paid out on average) with the disease category having the highest death rate? 

List of team members and a description of how each contributed to the project
1. Asaf Gal
   +Heatmap of Mortality Rates
2. Ashwin Jayaraman
3. Raphael Kintzer
4. Akshat Mittal


# Description of data


## Sources of the Data


The medicare dataset was collected from the website of Centers for Medicare and Medicaid Services (CMS). The links to the dataset can be found [here](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Medicare-Provider-Charge-Data/Inpatient.html). There is a file associated with each year. 

1. [2011](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Medicare-Provider-Charge-Data/Downloads/Inpatient_Data_2011_CSV.zip)
2. [2012](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Medicare-Provider-Charge-Data/Downloads/Inpatient_Data_2012_CSV.zip)
3. [2013](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Medicare-Provider-Charge-Data/Downloads/Inpatient_Data_2013_CSV.zip)
4. [2014](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Medicare-Provider-Charge-Data/Downloads/Inpatient_Data_2014_CSV.zip)
5. [2015](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Medicare-Provider-Charge-Data/Downloads/Inpatient_Data_2015_CSV.zip)
6. [2016](https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/Medicare-Provider-Charge-Data/Downloads/Inpatient_Data_2016_CSV.zip)



The Mortality dataset can be obtained from [here](https://cod.mortality.org/COD/USA/CODinputs/USAcod.csv). The link requires a credential to access the dataset. We had to apply to get the access (Username: "hmdcod" and Password: "magali").


While working on the dataset, it was found that the data was lacking in some key areas. We emailed the creator of the dataset and she emailed us 2 new datasets that she will soon publish on the website, one that includes the aggregate data for the US and other which includes mortality rates by states. 

<!-- Asaf's Part Goes Here -->

## General Description of Data


To best describe the data we will differentiate between the datasets and then explain the relationship between them. 
The Medicare dataset contains the following columns:

1. DRG Definition: The code and description identifying the Medicare Severity Diagnosis Related Groups (MS-DRG). They are a classification system that groups similar clinical conditions (diagnoses) and the procedures furnished by the hospital during an inpatient stay
2. Provider Id: The provider identifier assigned to the Medicare certified hospital facility. 
3. Provider Name: The name of the provider
4. Provider Street Address: The provider’s street address
5. Provider City: The city where the provider is located
6. Provider State: The state where the provider is located
7. Provider Zip Code: The provider’s zip code
8. Provider HRR: The Hospital Referral Region (HRR) where the provider is located
9. Total Discharges: The number of discharges billed by the provider for inpatient hospital services
10. Average Covered Charges: The provider's average charge for services covered by Medicare for all discharges in the DRG. These will vary from hospital to hospital because of differences in hospital charge structures
11. Average Total Payments: The average total payments to all providers for the MS-DRG including the MS- DRG amount, teaching, disproportionate share, capital, and outlier payments for all cases. Also included in average total payments are co-payment and deductible amounts that the patient is responsible for and any additional payments by third parties for coordination of benefits
12. Average Medicare Payments: The average amount that Medicare pays to the provider for Medicare's share of the MS-DRG. Average Medicare payment amounts include the MS-DRG amount, disproportionate share, capital, and outlier payments for all cases. Medicare payments do not include beneficiary co-payments and deductible amounts nor any additional payments from third parties for coordination of benefits.


The Mortality dataset contains the following columns

<!-- Asaf's Part Goes Here -->


# Analysis of data quality


## Description of Data Quality


There were some missing values for the cost of providers in the data. This can be visualized using the visna package:


```{r fig.height=10, fig.width=10}
visna(data)
```

We could see that there were 2 types of missing patterns in the medicare dataset.


1. The first pattern where all the column values were missing except for year. There were 4,147 such instances from the 1,080,374 rows. This contributed to 0.3% of the total data and all occured in the year 2013. 
2. The second pattern was where only the column Total Discharges was missing. These occurred in 41 rows in the dataset. 


We decided to ignore these rows since their contribution to the overall data was approximately 0.3%. As a result, our data for analysis consisted of 1,076,186 rows. 


Certain Diagnosis Related Groups only started appearing from the year 2014. There were 637 total Diagnosis Related Groups most of which were pretty similar. For example, there were Diagnosis Related Groups like


1. Heart Transplant Or Implant Of Heart Assist System W MCC
2. Heart Transplant Or Implant Of Heart Assist System W/O MCC


While researching online, we found out that the difference between the two was that one consisted of Heart Transplant on a person with Multiple Chronic Conditions and the other consisted of a Heart Transplant on a person without Multiple Chronic Conditions. These 2 DRGs were pretty similar to us and we decided to map them according to the diagnosis categories. 


We mapped the DRGs to the Diagnosis Categories using the following [source](https://en.wikipedia.org/wiki/Major_Diagnostic_Category).


While plotting the trend over time, we saw that CMS did not include certain DRGs before the year 2013. This can be visualized in the graph below, where each color is a different DRG:

```{r echo=FALSE}
#Loading cleaned data
data <- read_csv('Inpatient_Cost.csv')
```


```{r fig.height=10, fig.width=15}


filtered_data <- data  %>% group_by(Diagnostic_category, Year) %>% 
  dplyr::summarize(Average_Cost = sum(Total_Payments)/sum(`Total Discharges`)) %>% mutate(count = n())

ggplot(filtered_data, aes(x=Year, y=Average_Cost, color =Diagnostic_category )) + geom_line() +
  xlab('Year') + ylab('Average Cost') + ggtitle('Average Cost Trend by Diagnostic Category')
```


For the mortality dataset, we had the following findings about missing data


<!-- Asaf's Part Goes Here -->



# Main analysis


## Findings


We first decided to see how the costs varied by State in the US. Cleaning the cost variables by removing the ‘$’ and the ‘,’ in the dataset, we used the choropleth package to plot the same:


```{r echo=FALSE}
data(state.regions)
drg_grouped_by_year <-  data %>% group_by(`Diagnostic_category`, `Year`,`Provider State`) %>%
  summarise(Count_Discharge = sum(`Total Discharges`),Sum_Amount = sum(`Total_Payments`))

drg_grouped_by_year  <- drg_grouped_by_year  %>% group_by(`Year`) %>% mutate(Percent_Discharges = 100 * Count_Discharge/sum(Count_Discharge),
                                                                             Percent_Cost = 100 * Sum_Amount/sum(Sum_Amount))

total_cost_by_state <- drg_grouped_by_year %>% dplyr::group_by(`Provider State`) %>% 
  dplyr::summarise(Total_Discharges = sum(Count_Discharge),Total_Cost = sum(Sum_Amount))

total_cost_by_state$Average_Cost <- total_cost_by_state$Total_Cost/total_cost_by_state$Total_Discharges
colnames(total_cost_by_state)[1] <- 'State'

total_cost_by_state$region <- plyr::mapvalues(total_cost_by_state$State, from = state.regions$abb, to = state.regions$region)
total_cost_by_state$value <- total_cost_by_state$Average_Cost

```

```{r fig.height=10, fig.width=10}
state_choropleth(total_cost_by_state,title = "Average Cost by State",
                 legend = "Average Cost")
```


As expected, we noticed that California and New York have a high average cost of treatment. This can be attributed to the high cost of living in those states. On the other hand, Florida having such a low average cost seems to indicate that the treatments are generally cheaper in that state. 



We then investigated the total number of discharges by state:


```{r fig.height=10, fig.width=10}
total_cost_by_state$value<- total_cost_by_state$Total_Discharges
state_choropleth(total_cost_by_state,title = "Total Discharges by State",
                 legend = "Total Discharges")
```



As we can see, the overall number of discharges in Florida is actually quite high and are in the similar bucket to California and New York. 


The map showing discharges also indicates the population density of the US. States with high populous have a high number of discharges. 


When we compared this choropleth graph of Total Discharges by State to the previous graph Average Cost by State there were a few notable things. First, excluding New York and California the graphs are almost inversely related. The states with the highest number of discharges were actually the states with lower average cost. 


This comparison led us to want further breakdowns within each DRG for each state which could shed a little light as to why there is an inverse relationship. Based on these two graphs we also wondered whether a further breakdown of the DRG’s amongst the states could indicate whether <!-- Raphael's Part Goes Here -->




```{r echo = FALSE}
drg_cost <- drg_grouped_by_year %>% group_by(`Diagnostic_category`) %>% 
  dplyr::summarise(Average_Cost = sum(Sum_Amount)/sum(Count_Discharge))

```



We began our exploratory analysis by asking which Diagnoses Related Groups are the most expensive on average? We thought that this graph would give a good idea about which <!-- Raphael's Part Goes Here -->

```{r fig.height=10, fig.width=10}

ggplot(drg_cost, aes(x = reorder(Diagnostic_category,Average_Cost) ,y = Average_Cost)) + 
         geom_col() + scale_y_continuous(labels = function(l) { paste0(l/1000, "K")}) +
  coord_flip() + ylab('Average Cost') + xlab('DRG') + ggtitle('Average Cost by DRG')

```


```{r fig.height=10, fig.width=10}
drg_discharge <- drg_grouped_by_year %>% group_by(`Diagnostic_category`) %>% 
  dplyr::summarise(Discharge = max(Count_Discharge))

ggplot(drg_discharge, aes(x = reorder(Diagnostic_category,Discharge) ,y = Discharge)) + 
         geom_col() + scale_y_continuous(labels = function(l) { paste0(l/1000000, "M")}) +
  coord_flip() + ylab('Count') + xlab('DRG') + ggtitle('Number of Discharges by DRG')
```

This graph seeks to answer the question of which Diagnoses Related Groups are most commonly treated.  We arrived at this question because the prior graph “Average Cost by DRG” does not discuss to how many people were treated for a DRG. Therefore, it is possible that the DRG’s with the highest average cost could in fact be so expensive because they are rare.  This graph gives insight into whether any of the top ten DRG’s by average cost are also the top ten by Number of discharges.


# Executive summary

There were three main findings that we derived from our analysis:


1. When looking at the state map, we see that Alaska has a higher average cost compared to other states having a similar population. It’s median cost for most of the Diagnostic Categories are at the top. 

2. California and New York have a high average cost and high number of discharges. They contribute to the majority of the cost. Reducing their costs by 5% will reduce the overall spend by 

3. Going to treatment for Heart in Florida is more economical. Flight tickets from anywhere in the US to Miami Florida cost on average \$317.71 and you would be saving on average an amount of about \$20,000 (Average Cost of Heart Treatment Across US - Average Cost of Heart Treatment for Florida - Cost of Flight to Miami).


Bottom Line: Fly to Florida for Heart Treatment!


4. Mortality Dataset Findings
  <!-- Asaf's Part Goes Here -->
  
  
# Interactive component

## DRGApp

The aim of the interactive app is to make it easy to visualize, in several dimensions (year, number of discharges, type of disease etc), the scenario of healthcare costs in the US. Kindly note that this app is best viewed in Chrome (version 70+) at 100% zoom. It consists of two components:


1. Visualizing Medicare Costs in the US:

+ This component was aimed at enabling the user to see how the healthcare costs have changed over the years in their state, overall as well as the average treatment costs for particular disease group. 

+ The user is greeted with a choropleth of healthcare costs for the Medicare enrolled population averaged over 2011-2016 and all DRGs. Hovering over a state provides details of the value of average healthcare cost in that state as well as the total number of discharges in that state from 2011-2016.

+ Clicking on a particular state shows, in the side-panel, a line graph of trend of average healthcare costs over the years for that state. One remarkable fact evident from this graph is that the overall average healthcare cost shot up sharply in 2014 irrespective of the state

+ The app also provides user the feature to view the average costs for one or more disease categories (eg. Heart, Lungs etc.) over all the states. A second level of filter can be applied by choosing one or more diseases in the chosen disease category.

2. Find my Provider:
	
+ This component enables the user to see the most expensive and least expensive treatment providers in their state. The user can make a selection among all US states and the type of disease they are interested to check the providers for.

+ This app would help make an informed decision in choosing a healthcare provider by the expected expenditure for treatment.

## MortalityHeavyApp


# Conclusion

## Limitations 

1. The medicare dataset only looks at the Medicare population which is defined for populated aged 65 and above. This does not include the costs for the other age groups. 
 
2. We do not have the historical trends for the cost. The dataset starts from the year 2011. Having a historical perspective would allow us to see in which year did the percentage of increase in the costs increase the most. 

3. The Medicare dataset is also limited to the cost for the Inpatient Hospital Admissions. We do not have the data for the other types of services, mainly - 
The outpatient costs which includes the office visits and other annual wellness visits 
We no not have the Laboratory Costs and the Pharmaceutical Costs. 

4. We have an overall summary of the costs for each provider. This does not include the Patient Information, which is confidential. However, having a unique ID for the patients could allow us to see the quality of the providers. Having a high readmission rate after surgery could indicate that the surgeries were not effective and contributes a lot to the overall cost. 

5. The mortality dataset includes the overall numbers and does not provide the provider information. If we had that, we can combine the 2 datasets to also judge the effectiveness of a provider. 
</font>
	

